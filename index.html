<!doctype html>
<html lang="en">
<!-- html lang="en" ng-app="myApp" ng-strict-di -->
  <head>
    <title>Neural Net Builder</title>
    <script crossorigin="anonymous" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.8/angular.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/nnbuilder.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script>
    $( function() {
      var $componentPanel = $("#componentpanel");
      var $mainPanel = $("#mainpanel");

      var $compDetails = (function() {
        var allData = function() {
          return $.getJSON("components.json", function(result) {

          });
        };

        return {
          components: function(callback) {
            allData().done(function(data) {
              callback(data.components);
            });
          }
        };
      })();

      var $neuralNet = [{}];

      $(".chosencomponents").sortable();

      $("li", $componentPanel).draggable({
        cancel: "a.ui-icon",
        revert: "invalid",
        containment: "document",
        helper: "clone",
        cursor: "move",
        appendTo: "body"
      });

      $mainPanel.droppable({
        accept: "#componentpanel > li",
        classes: {
            "ui-droppable-active": "ui-state-highlight"
        },
        drop: function(event, ui) {
          //addComponent(ui.draggable)
          addComponent(ui);
        }
      });

      $componentPanel.droppable({
        accept: "#mainpanel li",
        classes: {
          "ui-droppable-active": "custom-state-active"
        },
        drop: function(event, ui) {
          removeComponent(ui.draggable);//take the image out of the mainPanel
        }
      });

      // Add component
      function addComponent( $item ) {
        var $list = $( "ul", $mainPanel );

        var $newItem = $item.helper.clone();
        $newItem.addClass("list-group-item");
        $newItem.removeAttr("style");
        $newItem
          .find("span.glyphicon-question-sign").remove().end();
        var $newSpan =
        "<span class='glyphicon glyphicon-wrench'></span>&nbsp;<span class='glyphicon glyphicon-remove-sign'></span>";
        $newItem.append($newSpan);//add $newSpan to $newItem
        $newItem.appendTo( $list );//add $newItem to ul

      }

      // Remove the "x's" parent component, a <li> element
      function removeComponent( $item ) {
        $parent = $item.context.parentElement;
        $parent.remove();
      }

      function editComponent( $item ) {
        $parentText = $item.context.parentElement.innerText.trim();
        var strText = "";
        var containsSettingsElements = 0;

        $compDetails.components(function(data) {
          $.each(data, function(n, v) {
            if (n == $parentText) {
              strText = "<div width='384' height='288' style='display: none; padding: 8px; text-align: left'><form><ul><fieldset class='csettings'><legend></legend>";
              $.each(v.settings, function(sn, sv) {
                containsSettingsElements = 1;
                //strText = "<li><label class='csettings' for='" + sn + "'>" + sn + "</label><input type='number' id='" + sn + "' size='5'/></li>";
                strText = strText + "<li><label for='" + sn + "'>" + sn + "</label> " + "<input type='number' name='" + sn + "' size=5 maxlength=5 /></li>";
              });
              if (containsSettingsElements == 1) {
                strText = strText + "<button class='btn btn-large btn-primary'><span class='glyphicon glyphicon-floppy-disk'></span></button>";
              }
              strText = strText + "</fieldset></ul></form></div>";
              var divt = $(strText).appendTo( "body" );
              setTimeout(function() {
                divt.dialog({
                  title: $parentText,
                  width: 400,
                  modal: true
                });
              }, 1 );
            }
          });
        });
      }

      // A modal window describing the component
      function describeComponent( $link ) {
        var $layerName = $link.context.nextSibling.data.trim();
        //console.log($layerName);

        $compDetails.components(function(data) {
          $.each(data, function(n, v) {
            //console.log('n: ' + n + '; d: ' + v['description']);
            if (n == $layerName) {
              var divt = $( "<div width='384' height='288' style='display: none; padding: 8px; text-align: left'>"
                + v['description'] + " <a target='_blank' style='background-color: lightgreen' href='" + v['external_link'] + "'>More...</a></div>")
                .appendTo( "body" );
              setTimeout(function() {
                divt.dialog({
                  title: n,
                  width: 400,
                  modal: true
                });
              }, 1 );
            }
          });
        });
      }

      // For dynamically added 'chosencomponents' in the mainpanel
      $(document).on( "click", "ul.chosencomponents > li", function( event ) {
        var $item = $( this ),
          $target = $( event.target );

        if ( $target.is( "span.glyphicon-remove-sign" ) ) {
          removeComponent( $target );
        } else if ($target.is( "span.glyphicon-wrench" ) ) {
          editComponent($target);
        }
        return false;
      });

      // For the static components in the 'componentpanel'
      $( "ul.componentpanel > li" ).on( "click", function( event ) {
        var $item = $( this ),
          $target = $( event.target );

        if ( $target.is( "span.glyphicon-question-sign" ) ) {
          describeComponent( $target );
        }
        return false;
      });

    });
  </script>
  </head>

  <body>
    <!-- h1>Welcome to neural net builder</h1 -->
    <div class="container" style="position:absolute; top:5%; left:5%; width:90%; height:90%;">

      <!-- components on the left -->
      <div class="ui-widget ui-helper-clearfix toolspanel" style="position:absolute; top:0%; left:0%; width:20%; height:100%;">
        <ul id="componentpanel" class="componentpanel ui-helper-reset ui-helper-clearfix">
          <li>
            <button class="btn btn-warning btn-large">
              <span class="glyphicon glyphicon-question-sign"></span>
              ConvNet2D
            </button>
          </li>
          <li>
            <button class="btn btn-primary btn-large">
              <span class="glyphicon glyphicon-question-sign"></span>
              ReLU
            </button>
          </li>

          <li>
            <button class="btn btn-success btn-large">
              <span class="glyphicon glyphicon-question-sign"></span>
              Pooling
            </button>
          </li>

          <li>
            <button class="btn btn-info btn-large">
              <span class="glyphicon glyphicon-question-sign"></span>
              Fully Connected
            </button>
          </li>
        </ul>

      </div>

      <!-- Main -->
      <div id="mainpanel" class="ui-widget-content ui-state-default"
      style="position:absolute; top:0%; left:20%; width:80%; height:60%; overflow:auto">
        <h4 class="ui-widget-header"><span class="ui-icon">Scratchpad</span>Scratchpad (Left to Right)</h4>
        <ul class='chosencomponents ui-helper-reset list-group'/>
      </div>

      <div class="codepanel jumbotron" style="position:absolute; top:60%; left:20%; width:80%; height:40%;overflow:auto">

        <div class="btn-group" role="group" style="position:absolute; top:0%; left:0%; width:40%; height:5%;">
          <button type="button" class="btn btn-default btn-xs">PyTorch</button>
          <button type="button" class="btn btn-default btn-xs">TensorFlow</button>
          <button type="button" class="btn btn-default btn-xs">Th-Lua</button>
        </div>

        <div class="btn-group" role="group" style="position:absolute; top:0%; left:40%; width:60%; height:10%; z-index:100;">
          <button type="button" class="btn btn-primary btn-lg">Generate Code</button>
        </div>

        <div class="tab-content" style="position:absolute; top:15%; left:0%; width:100%; height:95%;">
          <div id="PyTorch" class="">
            <pre><code>
import torch
import numpy as np
def tryThis():
  a=[]
  return
def tryThis():
  a=[]
  return
def tryThis():
  a=[]
  return

def tryThis():
  a=[]
  return
              </code></pre>
          </div>
        </div>

      </div><!--codePanel -->

    </div>

  </body>
  <script>
    (function() {
          var pre = document.getElementsByTagName('pre'),
              pl = pre.length;
          for (var i = 0; i < pl; i++) {
              pre[i].innerHTML = '<span class="line-number"></span>' + pre[i].innerHTML + '<span class="cl"></span>';
              var num = pre[i].innerHTML.split(/\n/).length;
              //console.log('num: ' + num);
              //console.log('pre[i]: [' + pre[i].innerHTML + ']');
              for (var j = 0; j < num; j++) {
                  var line_num = pre[i].getElementsByTagName('span')[0];
                  line_num.innerHTML += '<span>' + (j + 1) + '</span>';
              }
          }
      })();
    </script>
</html>
